export{enforce}from"n4s";import{createState as t}from"vast";import{assign as n,isUndefined as e,isStringValue as r,cache as u,asArray as i,nestedArray as o,seq as s,isNullish as a,deferThrow as c,invariant as f,isFunction as l,bindNot as d,either as p,isArray as v,optionalFunctionValue as E,isEmpty as m,isPositive as N,numberEquals as h,hasOwnProperty as g,callEach as y,bus as R,defaultTo as S,isPromise as T,isNotEmpty as C,isNull as I}from"vest-utils";import{createCascade as _}from"context";var A,O;function k(t,n){var e=n.suiteId,r=n.suiteName;return{optionalFields:t.registerStateKey((function(){return{}})),suiteId:t.registerStateKey(e),suiteName:t.registerStateKey(r),testCallbacks:t.registerStateKey((function(){return{fieldCallbacks:{},doneCallbacks:[]}})),testObjects:t.registerStateKey((function(t){return{prev:t?t.current:[],current:[]}}))}}function b(t,n){return void 0===n&&(n=[]),{cursor:(e={value:0},{current:function(){return e.value},next:function(){e.value++}}),keys:{current:{},prev:{}},path:n,type:t};var e}!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SUITE=1]="SUITE",t[t.EACH=2]="EACH",t[t.SKIP_WHEN=3]="SKIP_WHEN",t[t.OMIT_WHEN=4]="OMIT_WHEN",t[t.GROUP=5]="GROUP"}(A||(A={})),function(t){t[t.ALL=0]="ALL",t[t.EAGER=1]="EAGER"}(O||(O={}));var L=_((function(t,e){return e?null:n({exclusion:{tests:{},groups:{}},inclusion:{},isolate:b(A.DEFAULT),mode:[O.ALL]},t)}));function U(){return L.useX().isolate}function D(){var t=U();return t.path.concat(t.cursor.current())}function F(){return U().cursor}function P(){return L.useX().stateRef}function W(){return P().suiteId()[0]}function G(){return P().testCallbacks()}function w(){return P().optionalFields()}function x(t,e){(0,w()[1])((function(r){var u;return n(r,((u={})[t]=n({},r[t],e(r[t])),u))}))}function X(t){var n;return null!==(n=w()[0][t])&&void 0!==n?n:{}}function H(){return P().testObjects()}function K(){B((function(t){return t}))}function B(t){(0,H()[1])((function(n){var e=n.current;return{prev:n.prev,current:i(t(e))}}))}function M(){return j().filter((function(t){return t.isPending()}))}var q,V=u();function j(){var t=H()[0].current;return V([t],(function(){return o.flatten(t)}))}function Y(t){j().forEach(t)}!function(t){t.Error="error",t.Warning="warning"}(q||(q={}));var J,z,Q=function(){function t(t,n,e){var r=void 0===e?{}:e,u=r.message,i=r.groupName,o=r.key;this.key=null,this.id=s(),this.severity=q.Error,this.status=Z,this.fieldName=t,this.testFn=n,i&&(this.groupName=i),u&&(this.message=u),o&&(this.key=o)}return t.prototype.run=function(){var t;try{t=this.testFn()}catch(n){(function(t,n){return e(t)&&r(n)})(this.message,n)&&(this.message=n),t=!1}return!1===t&&this.fail(),t},t.prototype.setStatus=function(t){this.isFinalStatus()&&t!==it||(this.status=t)},t.prototype.warns=function(){return this.severity===q.Warning},t.prototype.setPending=function(){this.setStatus(rt)},t.prototype.fail=function(){this.setStatus(this.warns()?nt:tt)},t.prototype.done=function(){this.isFinalStatus()||this.setStatus(et)},t.prototype.warn=function(){this.severity=q.Warning},t.prototype.isFinalStatus=function(){return this.hasFailures()||this.isCanceled()||this.isPassing()},t.prototype.skip=function(t){this.isPending()&&!t||this.setStatus($)},t.prototype.cancel=function(){this.setStatus(ut),K()},t.prototype.reset=function(){this.status=Z,K()},t.prototype.omit=function(){this.setStatus(it)},t.prototype.valueOf=function(){return!this.isFailing()},t.prototype.isPending=function(){return this.statusEquals(rt)},t.prototype.isOmitted=function(){return this.statusEquals(it)},t.prototype.isUntested=function(){return this.statusEquals(Z)},t.prototype.isFailing=function(){return this.statusEquals(tt)},t.prototype.isCanceled=function(){return this.statusEquals(ut)},t.prototype.isSkipped=function(){return this.statusEquals($)},t.prototype.isPassing=function(){return this.statusEquals(et)},t.prototype.isWarning=function(){return this.statusEquals(nt)},t.prototype.hasFailures=function(){return this.isFailing()||this.isWarning()},t.prototype.isNonActionable=function(){return this.isSkipped()||this.isOmitted()||this.isCanceled()},t.prototype.isTested=function(){return this.hasFailures()||this.isPassing()},t.prototype.awaitsResolution=function(){return this.isSkipped()||this.isUntested()||this.isPending()},t.prototype.statusEquals=function(t){return this.status===t},t}(),Z="UNTESTED",$="SKIPPED",tt="FAILED",nt="WARNING",et="PASSING",rt="PENDING",ut="CANCELED",it="OMITTED";function ot(t,n){var e=t.type,r=void 0===e?A.DEFAULT:e;f(l(n));var u=b(r,D()),s=L.run({isolate:u},(function(){var t;return u.keys.prev=(t=H()[0].prev,i(o.getCurrent(t,D())).reduce((function(t,n){return n instanceof Q?(a(n.key)||(t[n.key]=n),t):t}),{})),B((function(t){return o.setValueAtPath(t,u.path,[])})),n()}));return F().next(),s}function st(t){return t===J.ERRORS?z.ERROR_COUNT:z.WARN_COUNT}function at(t,n){return!!n&&!ct(t,n)}function ct(t,n){return!(!n||t.fieldName!==n)}!function(t){t.WARNINGS="warnings",t.ERRORS="errors"}(J||(J={})),function(t){t.ERROR_COUNT="errorCount",t.WARN_COUNT="warnCount"}(z||(z={}));var ft,lt=d((function(t,n){return t.groupName===n}));function dt(t){return function(t,n){return j().some((function(e){return pt(e,t,n)}))}(J.ERRORS,t)}function pt(t,n,e){return!!t.hasFailures()&&(!at(t,e)&&!function(t,n){return p(t===J.WARNINGS,n.warns())}(n,t))}function vt(t){if(v(t)||r(t))i(t).forEach((function(t){x(t,(function(){return{type:ft.Delayed,applied:!1,rule:null}}))}));else{var n=function(n){var e=t[n];x(n,(function(){return{type:ft.Immediate,rule:e,applied:E(e)}}))};for(var e in t)n(e)}}function Et(t){return!!t&&X(t).applied}function mt(t){if(Et(t))return!0;var n=j();return!m(n)&&(!dt(t)&&(!function(t){return M().some((function(n){return ht(n,t)}))}(t)&&function(t){return j().every((function(n){return gt(n,t)}))}(t)))}function Nt(t,n){return!!Et(n)||!function(t,n,e){return j().some((function(r){return!lt(r,n)&&pt(r,t,e)}))}(J.ERRORS,t,n)&&(!function(t,n){return M().some((function(e){return!lt(e,t)&&ht(e,n)}))}(t,n)&&function(t,n){return j().every((function(e){return!!lt(e,t)||gt(e,n)}))}(t,n))}function ht(t,n){return!at(t,n)&&Et(n)}function gt(t,n){return!!at(t,n)||(function(t){return X(t.fieldName).type===ft.Delayed&&t.awaitsResolution()}(t)||t.isTested()||t.isOmitted())}function yt(){var t=j(),e=n({errorCount:0,warnCount:0,testCount:0},{groups:{},tests:{},valid:!1});return t.reduce((function(t,n){return function(t,n){t[n.fieldName]=Rt(t,n),t[n.fieldName].valid=!1!==t[n.fieldName].valid&&mt(n.fieldName)}(t.tests,n),function(t,n){var e=n.groupName;if(!e)return;t[e]=t[e]||{},t[e][n.fieldName]=Rt(t[e],n),t[e][n.fieldName].valid=!1!==t[e][n.fieldName].valid&&Nt(e,n.fieldName)}(t.groups,n),t}),e),e.valid=mt(),function(t){for(var n in t.tests)t.errorCount+=t.tests[n].errorCount,t.warnCount+=t.tests[n].warnCount,t.testCount+=t.tests[n].testCount;return t}(e)}function Rt(t,e){var r=e.fieldName,u=e.message;t[r]=t[r]||n({errorCount:0,warnCount:0,testCount:0},{errors:[],warnings:[]});var i=t[r];return e.isNonActionable()||(t[r].testCount++,e.isFailing()?o(J.ERRORS):e.isWarning()&&o(J.WARNINGS)),i;function o(t){var n=st(t);i[n]++,u&&(i[t]=(i[t]||[]).concat(u))}}function St(t,n,e){return e?function(t,n,e){var r;return(null===(r=null==t?void 0:t[e])||void 0===r?void 0:r[n])||[]}(t,n,e):function(t,n){var e={},r=st(n);for(var u in t)N(t[u][r])&&(e[u]=t[u][n]||[]);return e}(t,n)}function Tt(t){var n={getErrors:function(n){return Ct(t,J.ERRORS,n)},getErrorsByGroup:function(n,e){return It(t,J.ERRORS,n,e)},getWarnings:function(n){return Ct(t,J.WARNINGS,n)},getWarningsByGroup:function(n,e){return It(t,J.WARNINGS,n,e)},hasErrors:function(n){return Ot(t,z.ERROR_COUNT,n)},hasErrorsByGroup:function(n,e){return At(t,z.ERROR_COUNT,n,e)},hasWarnings:function(n){return Ot(t,z.WARN_COUNT,n)},hasWarningsByGroup:function(n,e){return At(t,z.WARN_COUNT,n,e)},isValid:function(n){var e;return n?Boolean(null===(e=t.tests[n])||void 0===e?void 0:e.valid):t.valid},isValidByGroup:function(n,e){var r=t.groups[n];if(!r)return!1;if(e)return _t(r,e);for(var u in r)if(!_t(r,u))return!1;return!0}};return n}function Ct(t,n,e){return St(t.tests,n,e)}function It(t,n,e,r){return St(t.groups[e],n,r)}function _t(t,n){var e;return!!(null===(e=t[n])||void 0===e?void 0:e.valid)}function At(t,n,e,r){var u,i,o=t.groups[e];if(!o)return!1;if(r)return N(null===(u=o[r])||void 0===u?void 0:u[n]);for(var s in o)if(N(null===(i=o[s])||void 0===i?void 0:i[n]))return!0;return!1}function Ot(t,n,e){var r,u=e?null===(r=t.tests[e])||void 0===r?void 0:r[n]:t[n]||0;return N(u)}!function(t){t[t.Immediate=0]="Immediate",t[t.Delayed=1]="Delayed"}(ft||(ft={}));var kt=u(1);function bt(){var t=j(),e={stateRef:P()};return kt([t],L.bind(e,(function(){var t=yt(),e=P().suiteName()[0];return n(t,Tt(t),{suiteName:e})})))}function Lt(t){var n=M();return!m(n)&&(!t||n.some((function(n){return ct(n,t)})))}var Ut=u(20);function Dt(){var t=j(),e={stateRef:P()};return Ut([t],L.bind(e,(function(){return n({},bt(),{done:L.bind(e,Gt)})})))}function Ft(t,n,e){var r;return!!(!l(t)||n&&h(null===(r=e.tests[n])||void 0===r?void 0:r.testCount,0))}function Pt(t){return!(Lt()&&(!t||Lt(t)))}var Wt,Gt=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var e=t.reverse(),r=e[0],u=e[1],i=Dt();if(Ft(r,u,i))return i;var o=function(){return r(bt())};return Pt(u)?(o(),i):(wt(o,u),i)};function wt(t,n){(0,G()[1])((function(e){return n?e.fieldCallbacks[n]=(e.fieldCallbacks[n]||[]).concat(t):e.doneCallbacks.push(t),e}))}function xt(){var t=w()[0];if(!m(t)){var n={};j().forEach((function(t){g(n,t.fieldName)?e(t):function(t){var r=X(t.fieldName);r.type===ft.Immediate&&(n[t.fieldName]=E(r.rule),e(t))}(t)})),K()}function e(t){n[t.fieldName]&&(t.omit(),x(t.fieldName,(function(){return{applied:!0}})))}}function Xt(){var t=R.createBus();return t.on(Wt.TEST_COMPLETED,(function(n){var e,r;n.isCanceled()||(n.done(),e=n.fieldName,r=G()[0].fieldCallbacks,e&&!Lt(e)&&v(r[e])&&y(r[e]),Lt()||t.emit(Wt.ALL_RUNNING_TESTS_FINISHED))})),t.on(Wt.SUITE_CALLBACK_DONE_RUNNING,(function(){xt()})),t.on(Wt.ALL_RUNNING_TESTS_FINISHED,(function(){var t;t=G()[0].doneCallbacks,y(t)})),t.on(Wt.REMOVE_FIELD,(function(t){Y((function(n){ct(n,t)&&(n.cancel(),function(t){B((function(n){return o.transform(n,(function(n){return t!==n?n:null}))}))}(n))}))})),t.on(Wt.RESET_FIELD,(function(t){Y((function(n){ct(n,t)&&n.reset()}))})),t}function Ht(){var t=L.useX();return f(t.bus),t.bus}function Kt(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var u=e.reverse(),i=u[0],o=u[1];f(l(i),"vest.create: Expected callback to be a function.");var a=Xt(),c=t(),d=k(c,{suiteId:s(),suiteName:o}),p={stateRef:d,bus:a},v=n(L.bind(p,(function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return c.reset(),ot({type:A.SUITE},(function(){i.apply(void 0,t)})),a.emit(Wt.SUITE_CALLBACK_DONE_RUNNING),Dt()})),{get:L.bind(p,bt),remove:L.bind(p,(function(t){a.emit(Wt.REMOVE_FIELD,t)})),reset:c.reset,resetField:L.bind(p,(function(t){a.emit(Wt.RESET_FIELD,t)}))});return v}function Bt(t,n){f(l(n),"each callback must be a function"),ot({type:A.EACH},(function(){t.forEach((function(t,e){n(t,e)}))}))}!function(t){t.TEST_COMPLETED="test_completed",t.ALL_RUNNING_TESTS_FINISHED="all_running_tests_finished",t.REMOVE_FIELD="remove_field",t.RESET_FIELD="reset_field",t.SUITE_CALLBACK_DONE_RUNNING="suite_callback_done_running"}(Wt||(Wt={}));function Mt(t,n){ot({type:A.SKIP_WHEN},(function(){L.run({skipped:qt()||E(t,E(bt))},(function(){return n()}))}))}function qt(){return!!L.useX().skipped}function Vt(t){return Jt(0,"tests",t)}function jt(t){return Jt(1,"tests",t)}function Yt(t){var n=t.fieldName,e=t.groupName;if(qt())return!0;var r=L.useX(),u=r.exclusion,i=r.inclusion,o=u.tests,s=o[n];if(!1===s)return!0;var a=!0===s;if(e){if(function(t){var n=L.useX().exclusion.groups;if(g(n,t))return!1===n[t];return Qt()}(e))return!0;if(!0===u.groups[e])return!a&&(!!zt(o)||!1===o[n])}return!!function(t){if(!Qt())return!1;return!t}(e)||!a&&(!!zt(o)&&!E(i[n]))}function Jt(t,n,e){var u=L.useX("hook called outside of a running suite.");e&&i(e).forEach((function(e){r(e)&&(u.exclusion[n][e]=0===t)}))}function zt(t){for(var n in t)if(!0===t[n])return!0;return!1}function Qt(){var t=L.useX().exclusion;for(var n in t.groups)if(t.groups[n])return!0;return!1}function Zt(t,n){f(r(t),$t("name must be a string")),f(l(n),$t("callback must be a function")),ot({type:A.GROUP},(function(){L.run({groupName:t},n)}))}function $t(t){return"Wrong arguments passed to group. Group ".concat(t,".")}function tn(t){var n=L.useX(),e=n.inclusion,u=n.exclusion;return f(r(t)),e[t]=S(u.tests[t],!0),{when:function(n){var e=L.useX(),u=e.inclusion,i=e.exclusion;u[t]=function(){return g(i.tests,t)?S(i.tests[t],!0):r(n)?Boolean(i.tests[n]):E(n,E(bt))}}}}function nn(){var t;t=O.EAGER,L.useX().mode[0]=t}function en(t){return n=O.EAGER,L.useX().mode[0]===n&&dt(t.fieldName);var n}function rn(t,n){ot({type:A.OMIT_WHEN},(function(){L.run({omitted:un()||E(t,E(bt))},(function(){return n()}))}))}function un(){return!!L.useX().omitted}function on(t,n,e){if(e||2===arguments.length)for(var r,u=0,i=n.length;u<i;u++)!r&&u in n||(r||(r=Array.prototype.slice.call(n,0,u)),r[u]=n[u]);return t.concat(r||Array.prototype.slice.call(n))}function sn(t,n){return t.fieldName===n.fieldName&&t.groupName===n.groupName}function an(t){var n=t.asyncTest,e=t.message;if(T(n)){var u=Ht().emit,i=P(),o=L.bind({stateRef:i},(function(){K(),u(Wt.TEST_COMPLETED,t)})),s=L.bind({stateRef:i},(function(n){t.isCanceled()||(t.message=r(n)?n:e,t.fail(),o())}));n.then(o,s)}}function cn(t){var n=Ht(),e=function(t){return L.run({currentTest:t},(function(){return t.run()}))}(t);try{T(e)?(t.asyncTest=e,t.setPending(),an(t)):n.emit(Wt.TEST_COMPLETED,t)}catch(n){throw new Error("Unexpected error encountered during test registration.\n      Test Object: ".concat(JSON.stringify(t),".\n      Error: ").concat(n,"."))}}function fn(t){var n=H()[0].prev;if(m(n))return ln(t),t;var e,r,u,i=(e=n,r=D(),o.valueAtPath(e,r));if(!a(t.key)){var s=function(t,n){var e=function(t){return U().keys.prev[t]}(t),r=n;e&&(r=e);return function(t,n){var e=U().keys.current;a(e[t])?e[t]=n:c('Encountered the same test key "'.concat(t,"\" twice. This may lead to tests overriding each other's results, or to tests being unexpectedly omitted."))}(t,r),r}(t.key,t);return ln(s),s}(function(t,n){return C(t)&&!sn(t,n)})(i,t)&&(!function(t,n){if(U().type===A.EACH)return;c("Vest Critical Error: Tests called in different order than previous run.\n    expected: ".concat(t.fieldName,"\n    received: ").concat(n.fieldName,'\n    This can happen on one of two reasons:\n    1. You\'re using if/else statements to conditionally select tests. Instead, use "skipWhen".\n    2. You are iterating over a list of tests, and their order changed. Use "each" and a custom key prop so that Vest retains their state.'))}(i,t),u=F().current(),B((function(t){return t.splice(u),t})),i=null);var f=S(i,t);return ln(f),f}function ln(t){var n=D();B((function(e){return o.setValueAtPath(e,n,t)}))}function dn(t){var n=F();if(en(t))return t.skip(),fn(t),n.next(),t;var e,r,u=fn(t);return un()||Et(t.fieldName)?(u.omit(),n.next(),u):Yt(t)?(u.skip(qt()),n.next(),u):((r=t)!==(e=u)&&sn(e,r)&&e.isPending()&&e.cancel(),ln(t),function(t){t.isUntested()?cn(t):T(t.asyncTest)&&(t.setPending(),an(t))}(t),n.next(),t)}function pn(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];var u=l(n[1])?n:on([void 0],n,!0),i=u[0],o=u[1],s=u[2];f(r(t),En("fieldName","string")),f(l(o),En("Test callback","function"));var a=L.useX(),c=new Q(t,o,{message:i,groupName:a.groupName,key:s});return dn(c)}Vt.group=function(t){return Jt(0,"groups",t)},jt.group=function(t){return Jt(1,"groups",t)};var vn=n(pn,{memo:function(t){var n=u(10);return function(e){for(var r=[],u=1;u<arguments.length;u++)r[u-1]=arguments[u];var i=F().current(),o=r.reverse(),s=o[0],a=o[1],c=o[2],f=[W(),e,i].concat(s),l=n.get(f);return I(l)?n(f,(function(){return t(e,c,a)})):l[1].isCanceled()?(n.invalidate(f),n(f,(function(){return t(e,c,a)}))):dn(l[1])}}(pn)});function En(t,n){return"Incompatible params passed to test function. ".concat(t," must be a ").concat(n)}function mn(){var t=L.useX("warn hook called outside of a running suite.");f(t.currentTest,"warn called outside of a test."),t.currentTest.warn()}var Nn="4.6.11";export{Nn as VERSION,L as context,Kt as create,Bt as each,nn as eager,Zt as group,tn as include,rn as omitWhen,Vt as only,vt as optional,jt as skip,Mt as skipWhen,Tt as suiteSelectors,vn as test,mn as warn};
