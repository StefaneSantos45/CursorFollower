"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t,n,e=require("n4s"),r=require("vast"),i=require("vest-utils"),u=require("context");function o(t,n){var e=n.suiteId,r=n.suiteName;return{optionalFields:t.registerStateKey((function(){return{}})),suiteId:t.registerStateKey(e),suiteName:t.registerStateKey(r),testCallbacks:t.registerStateKey((function(){return{fieldCallbacks:{},doneCallbacks:[]}})),testObjects:t.registerStateKey((function(t){return{prev:t?t.current:[],current:[]}}))}}function s(t,n){return void 0===n&&(n=[]),{cursor:(e={value:0},{current:function(){return e.value},next:function(){e.value++}}),keys:{current:{},prev:{}},path:n,type:t};var e}!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SUITE=1]="SUITE",t[t.EACH=2]="EACH",t[t.SKIP_WHEN=3]="SKIP_WHEN",t[t.OMIT_WHEN=4]="OMIT_WHEN",t[t.GROUP=5]="GROUP"}(t||(t={})),function(t){t[t.ALL=0]="ALL",t[t.EAGER=1]="EAGER"}(n||(n={}));var a=u.createCascade((function(e,r){return r?null:i.assign({exclusion:{tests:{},groups:{}},inclusion:{},isolate:s(t.DEFAULT),mode:[n.ALL]},e)}));function c(){return a.useX().isolate}function f(){var t=c();return t.path.concat(t.cursor.current())}function l(){return c().cursor}function p(){return a.useX().stateRef}function d(){return p().suiteId()[0]}function v(){return p().testCallbacks()}function E(){return p().optionalFields()}function h(t,n){(0,E()[1])((function(e){var r;return i.assign(e,((r={})[t]=i.assign({},e[t],n(e[t])),r))}))}function g(t){var n;return null!==(n=E()[0][t])&&void 0!==n?n:{}}function N(){return p().testObjects()}function m(){y((function(t){return t}))}function y(t){(0,N()[1])((function(n){var e=n.current;return{prev:n.prev,current:i.asArray(t(e))}}))}function R(){return C().filter((function(t){return t.isPending()}))}var S,T=i.cache();function C(){var t=N()[0].current;return T([t],(function(){return i.nestedArray.flatten(t)}))}function A(t){C().forEach(t)}!function(t){t.Error="error",t.Warning="warning"}(S||(S={}));var _,I,O=function(){function t(t,n,e){var r=void 0===e?{}:e,u=r.message,o=r.groupName,s=r.key;this.key=null,this.id=i.seq(),this.severity=S.Error,this.status=F,this.fieldName=t,this.testFn=n,o&&(this.groupName=o),u&&(this.message=u),s&&(this.key=s)}return t.prototype.run=function(){var t;try{t=this.testFn()}catch(n){(function(t,n){return i.isUndefined(t)&&i.isStringValue(n)})(this.message,n)&&(this.message=n),t=!1}return!1===t&&this.fail(),t},t.prototype.setStatus=function(t){this.isFinalStatus()&&t!==D||(this.status=t)},t.prototype.warns=function(){return this.severity===S.Warning},t.prototype.setPending=function(){this.setStatus(L)},t.prototype.fail=function(){this.setStatus(this.warns()?P:k)},t.prototype.done=function(){this.isFinalStatus()||this.setStatus(x)},t.prototype.warn=function(){this.severity=S.Warning},t.prototype.isFinalStatus=function(){return this.hasFailures()||this.isCanceled()||this.isPassing()},t.prototype.skip=function(t){this.isPending()&&!t||this.setStatus(b)},t.prototype.cancel=function(){this.setStatus(U),m()},t.prototype.reset=function(){this.status=F,m()},t.prototype.omit=function(){this.setStatus(D)},t.prototype.valueOf=function(){return!this.isFailing()},t.prototype.isPending=function(){return this.statusEquals(L)},t.prototype.isOmitted=function(){return this.statusEquals(D)},t.prototype.isUntested=function(){return this.statusEquals(F)},t.prototype.isFailing=function(){return this.statusEquals(k)},t.prototype.isCanceled=function(){return this.statusEquals(U)},t.prototype.isSkipped=function(){return this.statusEquals(b)},t.prototype.isPassing=function(){return this.statusEquals(x)},t.prototype.isWarning=function(){return this.statusEquals(P)},t.prototype.hasFailures=function(){return this.isFailing()||this.isWarning()},t.prototype.isNonActionable=function(){return this.isSkipped()||this.isOmitted()||this.isCanceled()},t.prototype.isTested=function(){return this.hasFailures()||this.isPassing()},t.prototype.awaitsResolution=function(){return this.isSkipped()||this.isUntested()||this.isPending()},t.prototype.statusEquals=function(t){return this.status===t},t}(),F="UNTESTED",b="SKIPPED",k="FAILED",P="WARNING",x="PASSING",L="PENDING",U="CANCELED",D="OMITTED";function W(n,e){var r=n.type,u=void 0===r?t.DEFAULT:r;i.invariant(i.isFunction(e));var o=s(u,f()),c=a.run({isolate:o},(function(){var t;return o.keys.prev=(t=N()[0].prev,i.asArray(i.nestedArray.getCurrent(t,f())).reduce((function(t,n){return n instanceof O?(i.isNullish(n.key)||(t[n.key]=n),t):t}),{})),y((function(t){return i.nestedArray.setValueAtPath(t,o.path,[])})),e()}));return l().next(),c}function w(t){return t===_.ERRORS?I.ERROR_COUNT:I.WARN_COUNT}function G(t,n){return!!n&&!V(t,n)}function V(t,n){return!(!n||t.fieldName!==n)}!function(t){t.WARNINGS="warnings",t.ERRORS="errors"}(_||(_={})),function(t){t.ERROR_COUNT="errorCount",t.WARN_COUNT="warnCount"}(I||(I={}));var q,X=i.bindNot((function(t,n){return t.groupName===n}));function H(t){return function(t,n){return C().some((function(e){return K(e,t,n)}))}(_.ERRORS,t)}function K(t,n,e){return!!t.hasFailures()&&(!G(t,e)&&!function(t,n){return i.either(t===_.WARNINGS,n.warns())}(n,t))}function M(t){return!!t&&g(t).applied}function B(t){if(M(t))return!0;var n=C();return!i.isEmpty(n)&&(!H(t)&&(!function(t){return R().some((function(n){return Y(n,t)}))}(t)&&function(t){return C().every((function(n){return J(n,t)}))}(t)))}function j(t,n){return!!M(n)||!function(t,n,e){return C().some((function(r){return!X(r,n)&&K(r,t,e)}))}(_.ERRORS,t,n)&&(!function(t,n){return R().some((function(e){return!X(e,t)&&Y(e,n)}))}(t,n)&&function(t,n){return C().every((function(e){return!!X(e,t)||J(e,n)}))}(t,n))}function Y(t,n){return!G(t,n)&&M(n)}function J(t,n){return!!G(t,n)||(function(t){return g(t.fieldName).type===q.Delayed&&t.awaitsResolution()}(t)||t.isTested()||t.isOmitted())}function z(){var t=C(),n=i.assign({errorCount:0,warnCount:0,testCount:0},{groups:{},tests:{},valid:!1});return t.reduce((function(t,n){return function(t,n){t[n.fieldName]=Q(t,n),t[n.fieldName].valid=!1!==t[n.fieldName].valid&&B(n.fieldName)}(t.tests,n),function(t,n){var e=n.groupName;if(!e)return;t[e]=t[e]||{},t[e][n.fieldName]=Q(t[e],n),t[e][n.fieldName].valid=!1!==t[e][n.fieldName].valid&&j(e,n.fieldName)}(t.groups,n),t}),n),n.valid=B(),function(t){for(var n in t.tests)t.errorCount+=t.tests[n].errorCount,t.warnCount+=t.tests[n].warnCount,t.testCount+=t.tests[n].testCount;return t}(n)}function Q(t,n){var e=n.fieldName,r=n.message;t[e]=t[e]||i.assign({errorCount:0,warnCount:0,testCount:0},{errors:[],warnings:[]});var u=t[e];return n.isNonActionable()||(t[e].testCount++,n.isFailing()?o(_.ERRORS):n.isWarning()&&o(_.WARNINGS)),u;function o(t){var n=w(t);u[n]++,r&&(u[t]=(u[t]||[]).concat(r))}}function Z(t,n,e){return e?function(t,n,e){var r;return(null===(r=null==t?void 0:t[e])||void 0===r?void 0:r[n])||[]}(t,n,e):function(t,n){var e={},r=w(n);for(var u in t)i.isPositive(t[u][r])&&(e[u]=t[u][n]||[]);return e}(t,n)}function $(t){var n={getErrors:function(n){return tt(t,_.ERRORS,n)},getErrorsByGroup:function(n,e){return nt(t,_.ERRORS,n,e)},getWarnings:function(n){return tt(t,_.WARNINGS,n)},getWarningsByGroup:function(n,e){return nt(t,_.WARNINGS,n,e)},hasErrors:function(n){return it(t,I.ERROR_COUNT,n)},hasErrorsByGroup:function(n,e){return rt(t,I.ERROR_COUNT,n,e)},hasWarnings:function(n){return it(t,I.WARN_COUNT,n)},hasWarningsByGroup:function(n,e){return rt(t,I.WARN_COUNT,n,e)},isValid:function(n){var e;return n?Boolean(null===(e=t.tests[n])||void 0===e?void 0:e.valid):t.valid},isValidByGroup:function(n,e){var r=t.groups[n];if(!r)return!1;if(e)return et(r,e);for(var i in r)if(!et(r,i))return!1;return!0}};return n}function tt(t,n,e){return Z(t.tests,n,e)}function nt(t,n,e,r){return Z(t.groups[e],n,r)}function et(t,n){var e;return!!(null===(e=t[n])||void 0===e?void 0:e.valid)}function rt(t,n,e,r){var u,o,s=t.groups[e];if(!s)return!1;if(r)return i.isPositive(null===(u=s[r])||void 0===u?void 0:u[n]);for(var a in s)if(i.isPositive(null===(o=s[a])||void 0===o?void 0:o[n]))return!0;return!1}function it(t,n,e){var r,u=e?null===(r=t.tests[e])||void 0===r?void 0:r[n]:t[n]||0;return i.isPositive(u)}!function(t){t[t.Immediate=0]="Immediate",t[t.Delayed=1]="Delayed"}(q||(q={}));var ut=i.cache(1);function ot(){var t=C(),n={stateRef:p()};return ut([t],a.bind(n,(function(){var t=z(),n=p().suiteName()[0];return i.assign(t,$(t),{suiteName:n})})))}function st(t){var n=R();return!i.isEmpty(n)&&(!t||n.some((function(n){return V(n,t)})))}var at=i.cache(20);function ct(){var t=C(),n={stateRef:p()};return at([t],a.bind(n,(function(){return i.assign({},ot(),{done:a.bind(n,dt)})})))}function ft(t,n,e){var r;return!!(!i.isFunction(t)||n&&i.numberEquals(null===(r=e.tests[n])||void 0===r?void 0:r.testCount,0))}function lt(t){return!(st()&&(!t||st(t)))}var pt,dt=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var e=t.reverse(),r=e[0],i=e[1],u=ct();if(ft(r,i,u))return u;var o=function(){return r(ot())};return lt(i)?(o(),u):(vt(o,i),u)};function vt(t,n){(0,v()[1])((function(e){return n?e.fieldCallbacks[n]=(e.fieldCallbacks[n]||[]).concat(t):e.doneCallbacks.push(t),e}))}function Et(){var t=E()[0];if(!i.isEmpty(t)){var n={};C().forEach((function(t){i.hasOwnProperty(n,t.fieldName)?e(t):function(t){var r=g(t.fieldName);r.type===q.Immediate&&(n[t.fieldName]=i.optionalFunctionValue(r.rule),e(t))}(t)})),m()}function e(t){n[t.fieldName]&&(t.omit(),h(t.fieldName,(function(){return{applied:!0}})))}}function ht(){var t=i.bus.createBus();return t.on(pt.TEST_COMPLETED,(function(n){var e,r;n.isCanceled()||(n.done(),e=n.fieldName,r=v()[0].fieldCallbacks,e&&!st(e)&&i.isArray(r[e])&&i.callEach(r[e]),st()||t.emit(pt.ALL_RUNNING_TESTS_FINISHED))})),t.on(pt.SUITE_CALLBACK_DONE_RUNNING,(function(){Et()})),t.on(pt.ALL_RUNNING_TESTS_FINISHED,(function(){var t;t=v()[0].doneCallbacks,i.callEach(t)})),t.on(pt.REMOVE_FIELD,(function(t){A((function(n){V(n,t)&&(n.cancel(),function(t){y((function(n){return i.nestedArray.transform(n,(function(n){return t!==n?n:null}))}))}(n))}))})),t.on(pt.RESET_FIELD,(function(t){A((function(n){V(n,t)&&n.reset()}))})),t}function gt(){var t=a.useX();return i.invariant(t.bus),t.bus}!function(t){t.TEST_COMPLETED="test_completed",t.ALL_RUNNING_TESTS_FINISHED="all_running_tests_finished",t.REMOVE_FIELD="remove_field",t.RESET_FIELD="reset_field",t.SUITE_CALLBACK_DONE_RUNNING="suite_callback_done_running"}(pt||(pt={}));function Nt(){return!!a.useX().skipped}function mt(t){return St(0,"tests",t)}function yt(t){return St(1,"tests",t)}function Rt(t){var n=t.fieldName,e=t.groupName;if(Nt())return!0;var r=a.useX(),u=r.exclusion,o=r.inclusion,s=u.tests,c=s[n];if(!1===c)return!0;var f=!0===c;if(e){if(function(t){var n=a.useX().exclusion.groups;if(i.hasOwnProperty(n,t))return!1===n[t];return Ct()}(e))return!0;if(!0===u.groups[e])return!f&&(!!Tt(s)||!1===s[n])}return!!function(t){if(!Ct())return!1;return!t}(e)||!f&&(!!Tt(s)&&!i.optionalFunctionValue(o[n]))}function St(t,n,e){var r=a.useX("hook called outside of a running suite.");e&&i.asArray(e).forEach((function(e){i.isStringValue(e)&&(r.exclusion[n][e]=0===t)}))}function Tt(t){for(var n in t)if(!0===t[n])return!0;return!1}function Ct(){var t=a.useX().exclusion;for(var n in t.groups)if(t.groups[n])return!0;return!1}function At(t){return"Wrong arguments passed to group. Group ".concat(t,".")}function _t(t){return e=n.EAGER,a.useX().mode[0]===e&&H(t.fieldName);var e}function It(){return!!a.useX().omitted}function Ot(t,n,e){if(e||2===arguments.length)for(var r,i=0,u=n.length;i<u;i++)!r&&i in n||(r||(r=Array.prototype.slice.call(n,0,i)),r[i]=n[i]);return t.concat(r||Array.prototype.slice.call(n))}function Ft(t,n){return t.fieldName===n.fieldName&&t.groupName===n.groupName}function bt(t){var n=t.asyncTest,e=t.message;if(i.isPromise(n)){var r=gt().emit,u=p(),o=a.bind({stateRef:u},(function(){m(),r(pt.TEST_COMPLETED,t)})),s=a.bind({stateRef:u},(function(n){t.isCanceled()||(t.message=i.isStringValue(n)?n:e,t.fail(),o())}));n.then(o,s)}}function kt(t){var n=gt(),e=function(t){return a.run({currentTest:t},(function(){return t.run()}))}(t);try{i.isPromise(e)?(t.asyncTest=e,t.setPending(),bt(t)):n.emit(pt.TEST_COMPLETED,t)}catch(n){throw new Error("Unexpected error encountered during test registration.\n      Test Object: ".concat(JSON.stringify(t),".\n      Error: ").concat(n,"."))}}function Pt(n){var e=N()[0].prev;if(i.isEmpty(e))return xt(n),n;var r,u,o,s=(r=e,u=f(),i.nestedArray.valueAtPath(r,u));if(!i.isNullish(n.key)){var a=function(t,n){var e=function(t){return c().keys.prev[t]}(t),r=n;e&&(r=e);return function(t,n){var e=c().keys.current;i.isNullish(e[t])?e[t]=n:i.deferThrow('Encountered the same test key "'.concat(t,"\" twice. This may lead to tests overriding each other's results, or to tests being unexpectedly omitted."))}(t,r),r}(n.key,n);return xt(a),a}(function(t,n){return i.isNotEmpty(t)&&!Ft(t,n)})(s,n)&&(!function(n,e){if(c().type===t.EACH)return;i.deferThrow("Vest Critical Error: Tests called in different order than previous run.\n    expected: ".concat(n.fieldName,"\n    received: ").concat(e.fieldName,'\n    This can happen on one of two reasons:\n    1. You\'re using if/else statements to conditionally select tests. Instead, use "skipWhen".\n    2. You are iterating over a list of tests, and their order changed. Use "each" and a custom key prop so that Vest retains their state.'))}(s,n),o=l().current(),y((function(t){return t.splice(o),t})),s=null);var p=i.defaultTo(s,n);return xt(p),p}function xt(t){var n=f();y((function(e){return i.nestedArray.setValueAtPath(e,n,t)}))}function Lt(t){var n=l();if(_t(t))return t.skip(),Pt(t),n.next(),t;var e,r,u=Pt(t);return It()||M(t.fieldName)?(u.omit(),n.next(),u):Rt(t)?(u.skip(Nt()),n.next(),u):((r=t)!==(e=u)&&Ft(e,r)&&e.isPending()&&e.cancel(),xt(t),function(t){t.isUntested()?kt(t):i.isPromise(t.asyncTest)&&(t.setPending(),bt(t))}(t),n.next(),t)}function Ut(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];var r=i.isFunction(n[1])?n:Ot([void 0],n,!0),u=r[0],o=r[1],s=r[2];i.invariant(i.isStringValue(t),Wt("fieldName","string")),i.invariant(i.isFunction(o),Wt("Test callback","function"));var c=a.useX(),f=new O(t,o,{message:u,groupName:c.groupName,key:s});return Lt(f)}mt.group=function(t){return St(0,"groups",t)},yt.group=function(t){return St(1,"groups",t)};var Dt=i.assign(Ut,{memo:function(t){var n=i.cache(10);return function(e){for(var r=[],u=1;u<arguments.length;u++)r[u-1]=arguments[u];var o=l().current(),s=r.reverse(),a=s[0],c=s[1],f=s[2],p=[d(),e,o].concat(a),v=n.get(p);return i.isNull(v)?n(p,(function(){return t(e,f,c)})):v[1].isCanceled()?(n.invalidate(p),n(p,(function(){return t(e,f,c)}))):Lt(v[1])}}(Ut)});function Wt(t,n){return"Incompatible params passed to test function. ".concat(t," must be a ").concat(n)}Object.defineProperty(exports,"enforce",{enumerable:!0,get:function(){return e.enforce}}),exports.VERSION="4.6.11",exports.context=a,exports.create=function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var u=n.reverse(),s=u[0],c=u[1];i.invariant(i.isFunction(s),"vest.create: Expected callback to be a function.");var f=ht(),l=r.createState(),p=o(l,{suiteId:i.seq(),suiteName:c}),d={stateRef:p,bus:f},v=i.assign(a.bind(d,(function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return l.reset(),W({type:t.SUITE},(function(){s.apply(void 0,n)})),f.emit(pt.SUITE_CALLBACK_DONE_RUNNING),ct()})),{get:a.bind(d,ot),remove:a.bind(d,(function(t){f.emit(pt.REMOVE_FIELD,t)})),reset:l.reset,resetField:a.bind(d,(function(t){f.emit(pt.RESET_FIELD,t)}))});return v},exports.each=function(n,e){i.invariant(i.isFunction(e),"each callback must be a function"),W({type:t.EACH},(function(){n.forEach((function(t,n){e(t,n)}))}))},exports.eager=function(){var t;t=n.EAGER,a.useX().mode[0]=t},exports.group=function(n,e){i.invariant(i.isStringValue(n),At("name must be a string")),i.invariant(i.isFunction(e),At("callback must be a function")),W({type:t.GROUP},(function(){a.run({groupName:n},e)}))},exports.include=function(t){var n=a.useX(),e=n.inclusion,r=n.exclusion;return i.invariant(i.isStringValue(t)),e[t]=i.defaultTo(r.tests[t],!0),{when:function(n){var e=a.useX(),r=e.inclusion,u=e.exclusion;r[t]=function(){return i.hasOwnProperty(u.tests,t)?i.defaultTo(u.tests[t],!0):i.isStringValue(n)?Boolean(u.tests[n]):i.optionalFunctionValue(n,i.optionalFunctionValue(ot))}}}},exports.omitWhen=function(n,e){W({type:t.OMIT_WHEN},(function(){a.run({omitted:It()||i.optionalFunctionValue(n,i.optionalFunctionValue(ot))},(function(){return e()}))}))},exports.only=mt,exports.optional=function(t){if(i.isArray(t)||i.isStringValue(t))i.asArray(t).forEach((function(t){h(t,(function(){return{type:q.Delayed,applied:!1,rule:null}}))}));else{var n=function(n){var e=t[n];h(n,(function(){return{type:q.Immediate,rule:e,applied:i.optionalFunctionValue(e)}}))};for(var e in t)n(e)}},exports.skip=yt,exports.skipWhen=function(n,e){W({type:t.SKIP_WHEN},(function(){a.run({skipped:Nt()||i.optionalFunctionValue(n,i.optionalFunctionValue(ot))},(function(){return e()}))}))},exports.suiteSelectors=$,exports.test=Dt,exports.warn=function(){var t=a.useX("warn hook called outside of a running suite.");i.invariant(t.currentTest,"warn called outside of a test."),t.currentTest.warn()};
