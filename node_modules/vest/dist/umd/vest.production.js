!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("n4s"),require("vast"),require("vest-utils"),require("context")):"function"==typeof define&&define.amd?define(["exports","n4s","vast","vest-utils","context"],t):t((n="undefined"!=typeof globalThis?globalThis:n||self).vest={},n.n4s,n.vast,n["vest-utils"],n.context)}(this,(function(n,t,e,r,i){"use strict";var u,o;function s(n,t){var e=t.suiteId,r=t.suiteName;return{optionalFields:n.registerStateKey((function(){return{}})),suiteId:n.registerStateKey(e),suiteName:n.registerStateKey(r),testCallbacks:n.registerStateKey((function(){return{fieldCallbacks:{},doneCallbacks:[]}})),testObjects:n.registerStateKey((function(n){return{prev:n?n.current:[],current:[]}}))}}function a(n,t){return void 0===t&&(t=[]),{cursor:(e={value:0},{current:function(){return e.value},next:function(){e.value++}}),keys:{current:{},prev:{}},path:t,type:n};var e}!function(n){n[n.DEFAULT=0]="DEFAULT",n[n.SUITE=1]="SUITE",n[n.EACH=2]="EACH",n[n.SKIP_WHEN=3]="SKIP_WHEN",n[n.OMIT_WHEN=4]="OMIT_WHEN",n[n.GROUP=5]="GROUP"}(u||(u={})),function(n){n[n.ALL=0]="ALL",n[n.EAGER=1]="EAGER"}(o||(o={}));var c=i.createCascade((function(n,t){return t?null:r.assign({exclusion:{tests:{},groups:{}},inclusion:{},isolate:a(u.DEFAULT),mode:[o.ALL]},n)}));function f(){return c.useX().isolate}function l(){var n=f();return n.path.concat(n.cursor.current())}function d(){return f().cursor}function p(){return c.useX().stateRef}function v(){return p().suiteId()[0]}function E(){return p().testCallbacks()}function h(){return p().optionalFields()}function g(n,t){(0,h()[1])((function(e){var i;return r.assign(e,((i={})[n]=r.assign({},e[n],t(e[n])),i))}))}function y(n){var t;return null!==(t=h()[0][n])&&void 0!==t?t:{}}function m(){return p().testObjects()}function N(){R((function(n){return n}))}function R(n){(0,m()[1])((function(t){var e=t.current;return{prev:t.prev,current:r.asArray(n(e))}}))}function S(){return A().filter((function(n){return n.isPending()}))}var T,C=r.cache();function A(){var n=m()[0].current;return C([n],(function(){return r.nestedArray.flatten(n)}))}function _(n){A().forEach(n)}!function(n){n.Error="error",n.Warning="warning"}(T||(T={}));var I,O,b=function(){function n(n,t,e){var i=void 0===e?{}:e,u=i.message,o=i.groupName,s=i.key;this.key=null,this.id=r.seq(),this.severity=T.Error,this.status=F,this.fieldName=n,this.testFn=t,o&&(this.groupName=o),u&&(this.message=u),s&&(this.key=s)}return n.prototype.run=function(){var n;try{n=this.testFn()}catch(t){(function(n,t){return r.isUndefined(n)&&r.isStringValue(t)})(this.message,t)&&(this.message=t),n=!1}return!1===n&&this.fail(),n},n.prototype.setStatus=function(n){this.isFinalStatus()&&n!==w||(this.status=n)},n.prototype.warns=function(){return this.severity===T.Warning},n.prototype.setPending=function(){this.setStatus(D)},n.prototype.fail=function(){this.setStatus(this.warns()?L:P)},n.prototype.done=function(){this.isFinalStatus()||this.setStatus(U)},n.prototype.warn=function(){this.severity=T.Warning},n.prototype.isFinalStatus=function(){return this.hasFailures()||this.isCanceled()||this.isPassing()},n.prototype.skip=function(n){this.isPending()&&!n||this.setStatus(k)},n.prototype.cancel=function(){this.setStatus(W),N()},n.prototype.reset=function(){this.status=F,N()},n.prototype.omit=function(){this.setStatus(w)},n.prototype.valueOf=function(){return!this.isFailing()},n.prototype.isPending=function(){return this.statusEquals(D)},n.prototype.isOmitted=function(){return this.statusEquals(w)},n.prototype.isUntested=function(){return this.statusEquals(F)},n.prototype.isFailing=function(){return this.statusEquals(P)},n.prototype.isCanceled=function(){return this.statusEquals(W)},n.prototype.isSkipped=function(){return this.statusEquals(k)},n.prototype.isPassing=function(){return this.statusEquals(U)},n.prototype.isWarning=function(){return this.statusEquals(L)},n.prototype.hasFailures=function(){return this.isFailing()||this.isWarning()},n.prototype.isNonActionable=function(){return this.isSkipped()||this.isOmitted()||this.isCanceled()},n.prototype.isTested=function(){return this.hasFailures()||this.isPassing()},n.prototype.awaitsResolution=function(){return this.isSkipped()||this.isUntested()||this.isPending()},n.prototype.statusEquals=function(n){return this.status===n},n}(),F="UNTESTED",k="SKIPPED",P="FAILED",L="WARNING",U="PASSING",D="PENDING",W="CANCELED",w="OMITTED";function G(n,t){var e=n.type,i=void 0===e?u.DEFAULT:e;r.invariant(r.isFunction(t));var o=a(i,l()),s=c.run({isolate:o},(function(){var n;return o.keys.prev=(n=m()[0].prev,r.asArray(r.nestedArray.getCurrent(n,l())).reduce((function(n,t){return t instanceof b?(r.isNullish(t.key)||(n[t.key]=t),n):n}),{})),R((function(n){return r.nestedArray.setValueAtPath(n,o.path,[])})),t()}));return d().next(),s}function V(n){return n===I.ERRORS?O.ERROR_COUNT:O.WARN_COUNT}function x(n,t){return!!t&&!q(n,t)}function q(n,t){return!(!t||n.fieldName!==t)}!function(n){n.WARNINGS="warnings",n.ERRORS="errors"}(I||(I={})),function(n){n.ERROR_COUNT="errorCount",n.WARN_COUNT="warnCount"}(O||(O={}));var X,H=r.bindNot((function(n,t){return n.groupName===t}));function K(n){return function(n,t){return A().some((function(e){return M(e,n,t)}))}(I.ERRORS,n)}function M(n,t,e){return!!n.hasFailures()&&(!x(n,e)&&!function(n,t){return r.either(n===I.WARNINGS,t.warns())}(t,n))}function B(n){return!!n&&y(n).applied}function j(n){if(B(n))return!0;var t=A();return!r.isEmpty(t)&&(!K(n)&&(!function(n){return S().some((function(t){return J(t,n)}))}(n)&&function(n){return A().every((function(t){return z(t,n)}))}(n)))}function Y(n,t){return!!B(t)||!function(n,t,e){return A().some((function(r){return!H(r,t)&&M(r,n,e)}))}(I.ERRORS,n,t)&&(!function(n,t){return S().some((function(e){return!H(e,n)&&J(e,t)}))}(n,t)&&function(n,t){return A().every((function(e){return!!H(e,n)||z(e,t)}))}(n,t))}function J(n,t){return!x(n,t)&&B(t)}function z(n,t){return!!x(n,t)||(function(n){return y(n.fieldName).type===X.Delayed&&n.awaitsResolution()}(n)||n.isTested()||n.isOmitted())}function Q(){var n=A(),t=r.assign({errorCount:0,warnCount:0,testCount:0},{groups:{},tests:{},valid:!1});return n.reduce((function(n,t){return function(n,t){n[t.fieldName]=Z(n,t),n[t.fieldName].valid=!1!==n[t.fieldName].valid&&j(t.fieldName)}(n.tests,t),function(n,t){var e=t.groupName;if(!e)return;n[e]=n[e]||{},n[e][t.fieldName]=Z(n[e],t),n[e][t.fieldName].valid=!1!==n[e][t.fieldName].valid&&Y(e,t.fieldName)}(n.groups,t),n}),t),t.valid=j(),function(n){for(var t in n.tests)n.errorCount+=n.tests[t].errorCount,n.warnCount+=n.tests[t].warnCount,n.testCount+=n.tests[t].testCount;return n}(t)}function Z(n,t){var e=t.fieldName,i=t.message;n[e]=n[e]||r.assign({errorCount:0,warnCount:0,testCount:0},{errors:[],warnings:[]});var u=n[e];return t.isNonActionable()||(n[e].testCount++,t.isFailing()?o(I.ERRORS):t.isWarning()&&o(I.WARNINGS)),u;function o(n){var t=V(n);u[t]++,i&&(u[n]=(u[n]||[]).concat(i))}}function $(n,t,e){return e?function(n,t,e){var r;return(null===(r=null==n?void 0:n[e])||void 0===r?void 0:r[t])||[]}(n,t,e):function(n,t){var e={},i=V(t);for(var u in n)r.isPositive(n[u][i])&&(e[u]=n[u][t]||[]);return e}(n,t)}function nn(n){var t={getErrors:function(t){return tn(n,I.ERRORS,t)},getErrorsByGroup:function(t,e){return en(n,I.ERRORS,t,e)},getWarnings:function(t){return tn(n,I.WARNINGS,t)},getWarningsByGroup:function(t,e){return en(n,I.WARNINGS,t,e)},hasErrors:function(t){return on(n,O.ERROR_COUNT,t)},hasErrorsByGroup:function(t,e){return un(n,O.ERROR_COUNT,t,e)},hasWarnings:function(t){return on(n,O.WARN_COUNT,t)},hasWarningsByGroup:function(t,e){return un(n,O.WARN_COUNT,t,e)},isValid:function(t){var e;return t?Boolean(null===(e=n.tests[t])||void 0===e?void 0:e.valid):n.valid},isValidByGroup:function(t,e){var r=n.groups[t];if(!r)return!1;if(e)return rn(r,e);for(var i in r)if(!rn(r,i))return!1;return!0}};return t}function tn(n,t,e){return $(n.tests,t,e)}function en(n,t,e,r){return $(n.groups[e],t,r)}function rn(n,t){var e;return!!(null===(e=n[t])||void 0===e?void 0:e.valid)}function un(n,t,e,i){var u,o,s=n.groups[e];if(!s)return!1;if(i)return r.isPositive(null===(u=s[i])||void 0===u?void 0:u[t]);for(var a in s)if(r.isPositive(null===(o=s[a])||void 0===o?void 0:o[t]))return!0;return!1}function on(n,t,e){var i,u=e?null===(i=n.tests[e])||void 0===i?void 0:i[t]:n[t]||0;return r.isPositive(u)}!function(n){n[n.Immediate=0]="Immediate",n[n.Delayed=1]="Delayed"}(X||(X={}));var sn=r.cache(1);function an(){var n=A(),t={stateRef:p()};return sn([n],c.bind(t,(function(){var n=Q(),t=p().suiteName()[0];return r.assign(n,nn(n),{suiteName:t})})))}function cn(n){var t=S();return!r.isEmpty(t)&&(!n||t.some((function(t){return q(t,n)})))}var fn=r.cache(20);function ln(){var n=A(),t={stateRef:p()};return fn([n],c.bind(t,(function(){return r.assign({},an(),{done:c.bind(t,En)})})))}function dn(n,t,e){var i;return!!(!r.isFunction(n)||t&&r.numberEquals(null===(i=e.tests[t])||void 0===i?void 0:i.testCount,0))}function pn(n){return!(cn()&&(!n||cn(n)))}var vn,En=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];var e=n.reverse(),r=e[0],i=e[1],u=ln();if(dn(r,i,u))return u;var o=function(){return r(an())};return pn(i)?(o(),u):(hn(o,i),u)};function hn(n,t){(0,E()[1])((function(e){return t?e.fieldCallbacks[t]=(e.fieldCallbacks[t]||[]).concat(n):e.doneCallbacks.push(n),e}))}function gn(){var n=h()[0];if(!r.isEmpty(n)){var t={};A().forEach((function(n){r.hasOwnProperty(t,n.fieldName)?e(n):function(n){var i=y(n.fieldName);i.type===X.Immediate&&(t[n.fieldName]=r.optionalFunctionValue(i.rule),e(n))}(n)})),N()}function e(n){t[n.fieldName]&&(n.omit(),g(n.fieldName,(function(){return{applied:!0}})))}}function yn(){var n=r.bus.createBus();return n.on(vn.TEST_COMPLETED,(function(t){var e,i;t.isCanceled()||(t.done(),e=t.fieldName,i=E()[0].fieldCallbacks,e&&!cn(e)&&r.isArray(i[e])&&r.callEach(i[e]),cn()||n.emit(vn.ALL_RUNNING_TESTS_FINISHED))})),n.on(vn.SUITE_CALLBACK_DONE_RUNNING,(function(){gn()})),n.on(vn.ALL_RUNNING_TESTS_FINISHED,(function(){var n;n=E()[0].doneCallbacks,r.callEach(n)})),n.on(vn.REMOVE_FIELD,(function(n){_((function(t){q(t,n)&&(t.cancel(),function(n){R((function(t){return r.nestedArray.transform(t,(function(t){return n!==t?t:null}))}))}(t))}))})),n.on(vn.RESET_FIELD,(function(n){_((function(t){q(t,n)&&t.reset()}))})),n}function mn(){var n=c.useX();return r.invariant(n.bus),n.bus}!function(n){n.TEST_COMPLETED="test_completed",n.ALL_RUNNING_TESTS_FINISHED="all_running_tests_finished",n.REMOVE_FIELD="remove_field",n.RESET_FIELD="reset_field",n.SUITE_CALLBACK_DONE_RUNNING="suite_callback_done_running"}(vn||(vn={}));var Nn="hook called outside of a running suite.";function Rn(){return!!c.useX().skipped}function Sn(n){return An(0,"tests",n)}function Tn(n){return An(1,"tests",n)}function Cn(n){var t=n.fieldName,e=n.groupName;if(Rn())return!0;var i=c.useX(),u=i.exclusion,o=i.inclusion,s=u.tests,a=s[t];if(!1===a)return!0;var f=!0===a;if(e){if(function(n){var t=c.useX().exclusion.groups;if(r.hasOwnProperty(t,n))return!1===t[n];return In()}(e))return!0;if(!0===u.groups[e])return!f&&(!!_n(s)||!1===s[t])}return!!function(n){if(!In())return!1;return!n}(e)||!f&&(!!_n(s)&&!r.optionalFunctionValue(o[t]))}function An(n,t,e){var i=c.useX(Nn);e&&r.asArray(e).forEach((function(e){r.isStringValue(e)&&(i.exclusion[t][e]=0===n)}))}function _n(n){for(var t in n)if(!0===n[t])return!0;return!1}function In(){var n=c.useX().exclusion;for(var t in n.groups)if(n.groups[t])return!0;return!1}function On(n){return"Wrong arguments passed to group. Group ".concat(n,".")}function bn(n){return t=o.EAGER,c.useX().mode[0]===t&&K(n.fieldName);var t}function Fn(){return!!c.useX().omitted}function kn(n,t,e){if(e||2===arguments.length)for(var r,i=0,u=t.length;i<u;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return n.concat(r||Array.prototype.slice.call(t))}function Pn(n,t){return n.fieldName===t.fieldName&&n.groupName===t.groupName}function Ln(n){var t=n.asyncTest,e=n.message;if(r.isPromise(t)){var i=mn().emit,u=p(),o=c.bind({stateRef:u},(function(){N(),i(vn.TEST_COMPLETED,n)})),s=c.bind({stateRef:u},(function(t){n.isCanceled()||(n.message=r.isStringValue(t)?t:e,n.fail(),o())}));t.then(o,s)}}function Un(n){var t=mn(),e=function(n){return c.run({currentTest:n},(function(){return n.run()}))}(n);try{r.isPromise(e)?(n.asyncTest=e,n.setPending(),Ln(n)):t.emit(vn.TEST_COMPLETED,n)}catch(t){throw new Error("Unexpected error encountered during test registration.\n      Test Object: ".concat(JSON.stringify(n),".\n      Error: ").concat(t,"."))}}function Dn(n){var t=m()[0].prev;if(r.isEmpty(t))return Wn(n),n;var e,i,o,s=(e=t,i=l(),r.nestedArray.valueAtPath(e,i));if(!r.isNullish(n.key)){var a=function(n,t){var e=function(n){return f().keys.prev[n]}(n),i=t;e&&(i=e);return function(n,t){var e=f().keys.current;r.isNullish(e[n])?e[n]=t:r.deferThrow('Encountered the same test key "'.concat(n,"\" twice. This may lead to tests overriding each other's results, or to tests being unexpectedly omitted."))}(n,i),i}(n.key,n);return Wn(a),a}(function(n,t){return r.isNotEmpty(n)&&!Pn(n,t)})(s,n)&&(!function(n,t){if(f().type===u.EACH)return;r.deferThrow("Vest Critical Error: Tests called in different order than previous run.\n    expected: ".concat(n.fieldName,"\n    received: ").concat(t.fieldName,'\n    This can happen on one of two reasons:\n    1. You\'re using if/else statements to conditionally select tests. Instead, use "skipWhen".\n    2. You are iterating over a list of tests, and their order changed. Use "each" and a custom key prop so that Vest retains their state.'))}(s,n),o=d().current(),R((function(n){return n.splice(o),n})),s=null);var c=r.defaultTo(s,n);return Wn(c),c}function Wn(n){var t=l();R((function(e){return r.nestedArray.setValueAtPath(e,t,n)}))}function wn(n){var t=d();if(bn(n))return n.skip(),Dn(n),t.next(),n;var e,i,u=Dn(n);return Fn()||B(n.fieldName)?(u.omit(),t.next(),u):Cn(n)?(u.skip(Rn()),t.next(),u):((i=n)!==(e=u)&&Pn(e,i)&&e.isPending()&&e.cancel(),Wn(n),function(n){n.isUntested()?Un(n):r.isPromise(n.asyncTest)&&(n.setPending(),Ln(n))}(n),t.next(),n)}function Gn(n){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];var i=r.isFunction(t[1])?t:kn([void 0],t,!0),u=i[0],o=i[1],s=i[2];r.invariant(r.isStringValue(n),xn("fieldName","string")),r.invariant(r.isFunction(o),xn("Test callback","function"));var a=c.useX(),f=new b(n,o,{message:u,groupName:a.groupName,key:s});return wn(f)}Sn.group=function(n){return An(0,"groups",n)},Tn.group=function(n){return An(1,"groups",n)};var Vn=r.assign(Gn,{memo:function(n){var t=r.cache(10);return function(e){for(var i=[],u=1;u<arguments.length;u++)i[u-1]=arguments[u];var o=d().current(),s=i.reverse(),a=s[0],c=s[1],f=s[2],l=[v(),e,o].concat(a),p=t.get(l);return r.isNull(p)?t(l,(function(){return n(e,f,c)})):p[1].isCanceled()?(t.invalidate(l),t(l,(function(){return n(e,f,c)}))):wn(p[1])}}(Gn)});function xn(n,t){return"Incompatible params passed to test function. ".concat(n," must be a ").concat(t)}Object.defineProperty(n,"enforce",{enumerable:!0,get:function(){return t.enforce}}),n.VERSION="4.6.11",n.context=c,n.create=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];var i=n.reverse(),o=i[0],a=i[1];r.invariant(r.isFunction(o),"vest.create: Expected callback to be a function.");var f=yn(),l=e.createState(),d=s(l,{suiteId:r.seq(),suiteName:a}),p={stateRef:d,bus:f},v=r.assign(c.bind(p,(function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];return l.reset(),G({type:u.SUITE},(function(){o.apply(void 0,n)})),f.emit(vn.SUITE_CALLBACK_DONE_RUNNING),ln()})),{get:c.bind(p,an),remove:c.bind(p,(function(n){f.emit(vn.REMOVE_FIELD,n)})),reset:l.reset,resetField:c.bind(p,(function(n){f.emit(vn.RESET_FIELD,n)}))});return v},n.each=function(n,t){r.invariant(r.isFunction(t),"each callback must be a function"),G({type:u.EACH},(function(){n.forEach((function(n,e){t(n,e)}))}))},n.eager=function(){var n;n=o.EAGER,c.useX().mode[0]=n},n.group=function(n,t){r.invariant(r.isStringValue(n),On("name must be a string")),r.invariant(r.isFunction(t),On("callback must be a function")),G({type:u.GROUP},(function(){c.run({groupName:n},t)}))},n.include=function(n){var t=c.useX(),e=t.inclusion,i=t.exclusion;return r.invariant(r.isStringValue(n)),e[n]=r.defaultTo(i.tests[n],!0),{when:function(t){var e=c.useX(),i=e.inclusion,u=e.exclusion;i[n]=function(){return r.hasOwnProperty(u.tests,n)?r.defaultTo(u.tests[n],!0):r.isStringValue(t)?Boolean(u.tests[t]):r.optionalFunctionValue(t,r.optionalFunctionValue(an))}}}},n.omitWhen=function(n,t){G({type:u.OMIT_WHEN},(function(){c.run({omitted:Fn()||r.optionalFunctionValue(n,r.optionalFunctionValue(an))},(function(){return t()}))}))},n.only=Sn,n.optional=function(n){if(r.isArray(n)||r.isStringValue(n))r.asArray(n).forEach((function(n){g(n,(function(){return{type:X.Delayed,applied:!1,rule:null}}))}));else{var t=function(t){var e=n[t];g(t,(function(){return{type:X.Immediate,rule:e,applied:r.optionalFunctionValue(e)}}))};for(var e in n)t(e)}},n.skip=Tn,n.skipWhen=function(n,t){G({type:u.SKIP_WHEN},(function(){c.run({skipped:Rn()||r.optionalFunctionValue(n,r.optionalFunctionValue(an))},(function(){return t()}))}))},n.suiteSelectors=nn,n.test=Vn,n.warn=function(){var n=c.useX("warn "+Nn);r.invariant(n.currentTest,"warn called outside of a test."),n.currentTest.warn()},Object.defineProperty(n,"__esModule",{value:!0})}));
